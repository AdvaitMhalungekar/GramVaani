<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gramvaani - Healthcare Information</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='healthcare.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
  <!-- Navbar - Same as main page -->
  <nav class="navbar">
    <div class="container nav-container">
      <div class="logo">
        <div class="logo-icon">
          <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Gramvaani Logo" class="logo-img">
        </div>
        <div class="logo-text">Gram<span class="accent">vaani</span></div>
      </div>
      <div class="header-actions">
        <div class="language-mic-wrapper">
          <div class="language-selector" onclick="toggleDropdown()">
            <i class="fas fa-globe"></i> हिन्दी <i class="fas fa-chevron-down"></i>
          </div>
          <button class="mic-navbar">
            <i class="fas fa-microphone"></i>
          </button>
        </div>
        <div class="language-dropdown" id="languageDropdown">
          <div class="dropdown-item">English</div>
          <div class="dropdown-item">हिन्दी</div>
          <div class="dropdown-item">मराठी</div>
          <div class="dropdown-item">தமிழ்</div>
          <div class="dropdown-item">বাংলা</div>
          <div class="dropdown-item">తెలుగు</div>
          <div class="dropdown-item">ગુજરાતી</div>
          <div class="dropdown-item">ଓଡ଼ିଆ</div>
          <div class="dropdown-item">ಕನ್ನಡ</div>
          <div class="dropdown-item">മലയാളം</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Healthcare Hero Section -->
  <div class="healthcare-hero">
    <div class="container">
      <div class="breadcrumb">
        <a href="/">Home</a> <i class="fas fa-chevron-right"></i> <span>Healthcare Information</span>
      </div>
      <h1 class="healthcare-title">Healthcare Information System</h1>
    </div>
  </div>

  <div class="container main-content">
    <!-- Healthcare Alerts -->
    <div class="healthcare-alerts">
      <h2 class="section-title"><i class="fas fa-bell"></i> Health Alerts</h2>

      <div class="alert-card alert-high">
        <div class="alert-icon">
          <i class="fas fa-virus"></i>
        </div>
        <div class="alert-content">
          <h3 class="alert-title">Seasonal Flu Advisory</h3>
          <p class="alert-message">Seasonal flu cases are on the rise. Get vaccinated at your nearest healthcare center.
            Wash hands frequently and stay hydrated.</p>
          <p class="alert-time">Issued: 8:45 AM, April 16, 2025</p>
        </div>
      </div>

      <div class="alert-card alert-medium">
        <div class="alert-icon">
          <i class="fas fa-pills"></i>
        </div>
        <div class="alert-content">
          <h3 class="alert-title">Vaccination Drive</h3>
          <p class="alert-message">Free vaccination camp for children under 5 years at the Primary Health Center from
            April 20-25, 2025. Bring your child's vaccination card.</p>
          <p class="alert-time">Issued: 9:30 AM, April 14, 2025</p>
        </div>
      </div>
    </div>

    <!-- Preventive Care Section -->
    <div class="preventive-care">
      <h2 class="section-title"><i class="fas fa-shield-virus"></i> Preventive Care</h2>

      <div class="care-card-container">
        <div class="care-card">
          <div class="care-icon">
            <i class="fas fa-hand-holding-water"></i>
          </div>
          <h3 class="care-title">Stay Hydrated</h3>
          <p class="care-content">Drink at least 8 glasses of clean water daily. During summer, increase water intake to
            prevent dehydration.</p>
        </div>

        <div class="care-card">
          <div class="care-icon">
            <i class="fas fa-handwashing"></i>
          </div>
          <h3 class="care-title">Hand Hygiene</h3>
          <p class="care-content">Wash hands with soap for at least 20 seconds frequently, especially before meals and
            after using the toilet.</p>
        </div>

        <div class="care-card">
          <div class="care-icon">
            <i class="fas fa-carrot"></i>
          </div>
          <h3 class="care-title">Balanced Diet</h3>
          <p class="care-content">Include fruits, vegetables, and whole grains in your diet. Locally grown seasonal
            vegetables are most nutritious.</p>
        </div>

        <div class="care-card">
          <div class="care-icon">
            <i class="fas fa-walking"></i>
          </div>
          <h3 class="care-title">Regular Exercise</h3>
          <p class="care-content">Engage in at least 30 minutes of physical activity daily. Walking, yoga, or farm work
            all count as exercise.</p>
        </div>
      </div>
    </div>

    <div class="content-wrapper">
      <!-- Health News Section -->
      <div class="news-section">
        <h2 class="section-title"><i class="fas fa-newspaper"></i> Health News</h2>

        <div class="news-card">
          <div class="news-image">
            <i class="fas fa-syringe"></i>
          </div>
          <div class="news-content">
            <h3 class="news-title">New Health Center Opens in Rajpur</h3>
            <p class="news-preview">A new Primary Health Center has been inaugurated in Rajpur village, offering 24/7
              emergency services and maternal care.</p>
            <p class="news-date">April 18, 2025</p>
          </div>
        </div>

        <div class="news-card">
          <div class="news-image">
            <i class="fas fa-lungs"></i>
          </div>
          <div class="news-content">
            <h3 class="news-title">Tuberculosis Awareness Campaign</h3>
            <p class="news-preview">Free TB screening camp to be held next week. Early detection leads to better
              treatment outcomes.</p>
            <p class="news-date">April 16, 2025</p>
          </div>
        </div>

        <div class="news-card">
          <div class="news-image">
            <i class="fas fa-baby"></i>
          </div>
          <div class="news-content">
            <h3 class="news-title">Maternal Health Initiative Launched</h3>
            <p class="news-preview">New program offers free prenatal checkups and nutrition supplements for pregnant
              women in rural areas.</p>
            <p class="news-date">April 15, 2025</p>
          </div>
        </div>

        <div class="news-card">
          <div class="news-image">
            <i class="fas fa-mosquito"></i>
          </div>
          <div class="news-content">
            <h3 class="news-title">Dengue Prevention Drive</h3>
            <p class="news-preview">Health workers conducting door-to-door awareness about mosquito-borne diseases. Free
              mosquito nets distribution next week.</p>
            <p class="news-date">April 14, 2025</p>
          </div>
        </div>
      </div>

      <!-- Health Chatbot Section -->
      <div class="chatbot-container">
        <div class="chatbot-header">
          <h2><i class="fas fa-robot"></i> Health Advisor</h2>
          <p>Get personalized health information and guidance</p>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              Hello! I'm your health advisor. I can help you with health information, preventive care tips, and guide
              you to the right healthcare services. What would you like to know?
            </div>
          </div>

          <div class="message user-message">
            <div class="message-content">
              What should I do for fever?
            </div>
            <div class="message-avatar">
              <i class="fas fa-user"></i>
            </div>
          </div>

          <div class="message bot-message">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              For fever, rest and drink plenty of fluids. Take paracetamol if your temperature is above 38°C (100.4°F).
              If fever persists for more than 3 days or is accompanied by severe symptoms, please visit your nearest
              healthcare facility.
            </div>
          </div>
        </div>

        <div class="chat-input">
          <button id="micButton" title="Speak your question">
            <i class="fas fa-microphone"></i>
          </button>
          <input type="text" id="userMessage" placeholder="Ask about health issues, symptoms, or medicines...">
          <button id="sendMessage">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>

        <div class="quick-questions">
          <div class="quick-question-btn">Where's the nearest doctor?</div>
          <div class="quick-question-btn">Common cold remedies</div>
          <div class="quick-question-btn">When to vaccinate my child?</div>
        </div>
      </div>
    </div>

    <!-- Nearby Hospitals Map Section -->
    <div class="map-section">
      <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Nearby Healthcare Facilities</h2>
      <div class="map-container">
        <div id="map"></div>
        <div class="map-legend">
          <div class="legend-item">
            <div class="legend-marker hospital-marker"></div>
            <span>Hospital</span>
          </div>
          <div class="legend-item">
            <div class="legend-marker clinic-marker"></div>
            <span>Clinic</span>
          </div>
          <div class="legend-item">
            <div class="legend-marker pharmacy-marker"></div>
            <span>Pharmacy</span>
          </div>
          <div class="legend-item">
            <div class="legend-marker you-marker"></div>
            <span>Your Location</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Services Section -->
    <div class="health-services">
      <h2 class="section-title"><i class="fas fa-briefcase-medical"></i> Health Services</h2>

      <div class="services-container">
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-stethoscope"></i>
          </div>
          <div class="service-content">
            <h3 class="service-title">Primary Health Center</h3>
            <p class="service-description">Basic healthcare services including vaccinations, maternal care, and
              treatment of common illnesses.</p>
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>9:00 AM - 5:00 PM</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>1800-123-4567</span>
              </div>
            </div>
          </div>
        </div>

        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-ambulance"></i>
          </div>
          <div class="service-content">
            <h3 class="service-title">Emergency Services</h3>
            <p class="service-description">24/7 emergency medical services. Ambulance available for transportation to
              district hospital.</p>
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>24 Hours</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>108</span>
              </div>
            </div>
          </div>
        </div>

        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-baby"></i>
          </div>
          <div class="service-content">
            <h3 class="service-title">Maternal & Child Health</h3>
            <p class="service-description">Prenatal care, delivery services, and pediatric care for children up to 5
              years of age.</p>
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>9:00 AM - 4:00 PM</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>1800-123-5678</span>
              </div>
            </div>
          </div>
        </div>

        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-capsules"></i>
          </div>
          <div class="service-content">
            <h3 class="service-title">Pharmacy Services</h3>
            <p class="service-description">Free essential medicines available at government health centers. Generic
              medicines at affordable prices.</p>
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>9:00 AM - 6:00 PM</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>1800-123-6789</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer - Same as main page -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Gramvaani Logo" class="footer-logo-img">
          <span>Gramvaani</span>
        </div>
        <p class="footer-tagline">Voice of the Village</p>
      </div>
      <div class="footer-links">
        <a href="#">About Us</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Contact</a>
        <a href="#">Help</a>
      </div>
    </div>
  </footer>

  <div class="mic-button">
    <div class="pulse-ring"></div>
    <div class="mic-icon">
      <i class="fas fa-microphone"></i>
    </div>
    <div class="mic-tooltip">Tap to speak</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize map with improved loading and error handling
    document.addEventListener('DOMContentLoaded', function () {
      // Show loading indicator
      const mapLoading = document.getElementById('map-loading');

      // Initialize map
      const map = L.map('map', {
        attributionControl: false,
        zoomControl: false
      }).setView([20.5937, 78.9629], 5); // Default to India

      // Add customized zoom control
      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);

      // Add attribution control
      L.control.attribution({
        position: 'bottomleft'
      }).addTo(map).setPrefix('').addAttribution('© OpenStreetMap contributors');

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);

      // Hide loading indicator after tiles loaded
      map.whenReady(function () {
        if (mapLoading) mapLoading.style.display = 'none';
      });

      // Get user's location
      map.locate({ setView: true, maxZoom: 12, timeout: 10000 });

      // When location is found
      map.on('locationfound', function (e) {
        const userLat = e.latitude;
        const userLon = e.longitude;

        // Add user marker with accessibility
        const userMarker = L.marker([userLat, userLon]).addTo(map);
        userMarker.bindPopup("<strong>Your Location</strong>").openPopup();

        // Fetch nearby hospitals from backend
        fetch('/nearby_hospitals', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            lat: userLat,
            lon: userLon
          })
        })
          .then(response => response.json())
          .then(facilities => {
            // Add facility markers
            facilities.forEach(facility => {
              let lat, lon, name, type;

              // Extract location data based on facility type
              if (facility.type === 'node') {
                lat = facility.lat;
                lon = facility.lon;
              } else {
                // For ways and relations with center point
                lat = facility.center.lat;
                lon = facility.center.lon;
              }

              // Extract name and type
              name = facility.tags && facility.tags.name ? facility.tags.name : "Healthcare Facility";
              type = facility.tags && facility.tags.amenity ? facility.tags.amenity : "Hospital";

              // Create marker
              const facilityMarker = L.marker([lat, lon]).addTo(map);
              facilityMarker.bindPopup(`<strong>${name}</strong><br>${type}`);
            });
          })
          .catch(error => {
            console.error('Error fetching nearby hospitals:', error);
          });
      });

      // On location error - show friendly message with retry option
      map.on('locationerror', function (e) {
        if (mapLoading) mapLoading.style.display = 'none';

        // Create error message overlay
        const errorDiv = document.createElement('div');
        errorDiv.className = 'map-error';
        errorDiv.innerHTML = `
      <p><i class="fas fa-map-marker-alt"></i> Location access denied or unavailable</p>
      <button id="retryLocation">Try Again</button>
    `;
        document.getElementById('map').appendChild(errorDiv);

        // Add retry button functionality
        document.getElementById('retryLocation').addEventListener('click', function () {
          errorDiv.remove();
          if (mapLoading) mapLoading.style.display = 'block';
          map.locate({ setView: true, maxZoom: 12 });
        });
      });
    });

    // Fetch health news from backend
    function fetchHealthNews() {
      fetch('/health_news')
        .then(response => response.json())
        .then(newsItems => {
          const newsSection = document.querySelector('.news-section');
          // Clear existing news cards except the heading
          const heading = newsSection.querySelector('h2');
          newsSection.innerHTML = '';
          newsSection.appendChild(heading);

          // Display up to 4 news items
          const displayCount = Math.min(newsItems.length, 4);
          for (let i = 0; i < displayCount; i++) {
            const news = newsItems[i];

            // Create date object from the pubDate string
            const pubDate = new Date(news.pubDate);
            const formattedDate = pubDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            // Create news card
            const articleElem = document.createElement('article');
            articleElem.className = 'news-card';

            // Determine icon based on title keywords
            let iconClass = 'fas fa-newspaper';
            const title = news.title.toLowerCase();
            if (title.includes('covid') || title.includes('virus') || title.includes('infection')) {
              iconClass = 'fas fa-virus';
            } else if (title.includes('vaccine') || title.includes('vaccination')) {
              iconClass = 'fas fa-syringe';
            } else if (title.includes('heart') || title.includes('cardiac')) {
              iconClass = 'fas fa-heartbeat';
            } else if (title.includes('mental') || title.includes('brain')) {
              iconClass = 'fas fa-brain';
            } else if (title.includes('pill') || title.includes('medicine') || title.includes('drug')) {
              iconClass = 'fas fa-pills';
            }

            articleElem.innerHTML = `
          <div class="news-image" aria-hidden="true">
            <i class="${iconClass}"></i>
          </div>
          <div class="news-content">
            <h3 class="news-title">${news.title}</h3>
            <p class="news-preview">${news.descripion || 'Click to read more.'}</p>
            <p class="news-date"><time datetime="${pubDate.toISOString()}">${formattedDate}</time></p>
            <a href="${news.link}" target="_blank" class="news-link" aria-label="Read more about ${news.title}">Read more</a>
          </div>
        `;

            newsSection.appendChild(articleElem);
          }
        })
        .catch(error => {
          console.error('Error fetching health news:', error);
        });
    }

    // Enhanced chatbot functionality with keyboard support
    document.getElementById('sendMessage').addEventListener('click', function () {
      sendMessage();
    });

    document.getElementById('userMessage').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Quick question buttons with keyboard support
    const quickQuestions = document.querySelectorAll('.quick-question-btn');
    quickQuestions.forEach(button => {
      button.addEventListener('click', function () {
        const question = this.textContent;
        document.getElementById('userMessage').value = question;
        sendMessage();
      });

      button.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const question = this.textContent;
          document.getElementById('userMessage').value = question;
          sendMessage();
        }
      });
    });

    // Handle microphone button click
    document.getElementById('micButton').addEventListener('click', function () {
      // Check if speech recognition is available
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'en-IN'; // Set language to Indian English
        recognition.continuous = false;
        recognition.interimResults = false;

        // Add visual feedback for recording
        this.classList.add('recording');

        recognition.start();

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('userMessage').value = transcript;
          document.getElementById('micButton').classList.remove('recording');
          sendMessage();
        };

        recognition.onerror = function () {
          document.getElementById('micButton').classList.remove('recording');
          alert("Speech recognition error. Please try again or type your question.");
        };

        recognition.onend = function () {
          document.getElementById('micButton').classList.remove('recording');
        };
      } else {
        alert("Speech recognition is not supported in your browser. Please type your question.");
      }
    });

    function sendMessage() {
      const userInput = document.getElementById('userMessage');
      const message = userInput.value.trim();

      if (message) {
        // Add user message
        addMessage(message, 'user');

        // Clear input
        userInput.value = '';

        // Add loading indicator
        const loadingId = 'msg-loading-' + Date.now();
        addLoadingMessage(loadingId);

        // Send to backend health advisor API
        fetch('/chat_health', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `message=${encodeURIComponent(message)}`
        })
          .then(response => response.json())
          .then(data => {
            // Remove loading indicator
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            // Add bot response
            addMessage(data.response, 'bot');
          })
          .catch(error => {
            console.error('Error:', error);

            // Remove loading indicator
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            // Add error message
            addMessage("I'm sorry, I couldn't process your request at the moment. Please try again later.", 'bot');
          });
      }
    }

    function addLoadingMessage(id) {
      const chatMessages = document.getElementById('chatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message loading-message';
      loadingDiv.id = id;

      loadingDiv.innerHTML = `
    <div class="message-avatar" aria-hidden="true">
      <i class="fas fa-user-md"></i>
    </div>
    <div class="message-content">
      <span class="typing-indicator">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
    </div>
  `;

      chatMessages.appendChild(loadingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessage(text, sender) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;

      if (sender === 'bot') {
        messageDiv.innerHTML = `
      <div class="message-avatar" aria-hidden="true">
        <i class="fas fa-user-md"></i>
      </div>
      <div class="message-content">
        <span class="sr-only">Health Advisor says:</span>
        ${text}
      </div>
    `;
      } else {
        messageDiv.innerHTML = `
      <div class="message-content">
        <span class="sr-only">You said:</span>
        ${text}
      </div>
      <div class="message-avatar" aria-hidden="true">
        <i class="fas fa-user"></i>
      </div>
    `;
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Announce new message for screen readers
      const announcer = document.createElement('div');
      announcer.className = 'sr-only';
      announcer.setAttribute('aria-live', 'assertive');
      announcer.textContent = sender === 'bot' ? 'New message from Health Advisor' : 'Your message sent';
      document.body.appendChild(announcer);

      // Remove after announcement
      setTimeout(() => {
        document.body.removeChild(announcer);
      }, 1000);
    }

    // Load health news when the page loads
    document.addEventListener('DOMContentLoaded', function () {
      fetchHealthNews();
    });
  </script>
</body>

</html>